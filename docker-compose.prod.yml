# Docker Compose for Production
# Usage: docker-compose -f docker-compose.prod.yml up -d
#
# REQUIRED environment variables (create a .env file or export them):
# - JWT_SECRET: Strong secret key for JWT tokens
# - ADMIN_USERNAME: Admin login username
# - ADMIN_PASSWORD: Strong admin password
# - DB_PASSWORD: Database password
# - MYSQL_ROOT_PASSWORD: MySQL root password
# - CORS_ORIGIN: Frontend URL (e.g., https://tecnohogar.com)
# - VITE_API_URL: Backend API URL (e.g., https://api.tecnohogar.com/api)

services:
  # Base de datos MySQL
  mysql:
    image: mysql:8.0
    container_name: techno-hogar-db
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${DB_DATABASE:-techno_hogar}
      MYSQL_USER: ${DB_USERNAME:-techno_user}
      MYSQL_PASSWORD: ${DB_PASSWORD}
    volumes:
      - mysql_data:/var/lib/mysql
      - ./backend/database/init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - techno-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      timeout: 20s
      retries: 10

  # Backend NestJS
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile.prod
    container_name: techno-hogar-backend
    restart: always
    environment:
      NODE_ENV: production
      DB_HOST: mysql
      DB_PORT: 3306
      DB_USERNAME: ${DB_USERNAME:-techno_user}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_DATABASE: ${DB_DATABASE:-techno_hogar}
      PORT: 3000
      # Auth - REQUIRED
      JWT_SECRET: ${JWT_SECRET}
      ADMIN_USERNAME: ${ADMIN_USERNAME}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD}
      # CORS - REQUIRED
      CORS_ORIGIN: ${CORS_ORIGIN}
      # Optional services
      WHATSAPP_NOTIFICATIONS_ENABLED: ${WHATSAPP_NOTIFICATIONS_ENABLED:-false}
      WHATSAPP_ADMIN_PHONE: ${WHATSAPP_ADMIN_PHONE:-}
      GOOGLE_SHEETS_ENABLED: ${GOOGLE_SHEETS_ENABLED:-false}
    ports:
      - "3000:3000"
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - techno-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Frontend React (served by nginx)
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.prod
      args:
        VITE_API_URL: ${VITE_API_URL}
        VITE_WHATSAPP_PHONE: ${VITE_WHATSAPP_PHONE:-5218441972327}
        VITE_PHONE_NUMBER: ${VITE_PHONE_NUMBER:-5218444180769}
    container_name: techno-hogar-frontend
    restart: always
    ports:
      - "80:80"
    depends_on:
      - backend
    networks:
      - techno-network

volumes:
  mysql_data:
    driver: local

networks:
  techno-network:
    driver: bridge
